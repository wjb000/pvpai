<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Battle Royale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        /* Wallet Connection Modal */
        #walletModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        #walletModal.hidden {
            display: none;
        }
        .wallet-container {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #00ffff;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.5);
            max-width: 500px;
            width: 90%;
        }
        .wallet-container h2 {
            color: #00ffff;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .wallet-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        .wallet-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .wallet-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .wallet-btn.metamask {
            background: linear-gradient(135deg, #f6851b, #e2761b);
        }
        .wallet-btn.phantom {
            background: linear-gradient(135deg, #ab9ff2, #5b4cdb);
        }
        .wallet-btn.coinbase {
            background: linear-gradient(135deg, #0052ff, #0041cc);
        }
        .ai-section {
            border-top: 2px solid #00ffff;
            padding-top: 20px;
            margin-top: 20px;
        }
        .ai-section h3 {
            color: #00ffff;
            margin-bottom: 15px;
            text-align: center;
        }
        #apiKeyInput {
            width: 100%;
            padding: 12px;
            border: 2px solid #00ffff;
            border-radius: 8px;
            background: rgba(0, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
        }
        #apiKeyInput::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .info-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
        }

        /* Lobby Modal */
        #lobbyModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        #lobbyModal.visible {
            display: flex;
        }
        .lobby-container {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #ffd700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.5);
            max-width: 600px;
            width: 90%;
        }
        .lobby-container h2 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 20px;
        }
        .stake-input-group {
            margin-bottom: 30px;
        }
        .stake-input-group label {
            color: white;
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        #stakeAmount {
            width: 100%;
            padding: 15px;
            border: 2px solid #ffd700;
            border-radius: 8px;
            background: rgba(255, 215, 0, 0.1);
            color: white;
            font-size: 18px;
            text-align: center;
        }
        .color-picker-section {
            margin-bottom: 30px;
        }
        .color-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }
        .players-waiting {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .players-waiting h3 {
            color: #00ffff;
            margin-bottom: 15px;
        }
        .player-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .player-item {
            background: rgba(0, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            display: flex;
            justify-content: space-between;
        }
        .player-item.ai {
            background: rgba(255, 0, 255, 0.1);
        }
        #joinGameBtn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #00ff88, #00cc66);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        #joinGameBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }
        #joinGameBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* HUD */
        #gameHUD {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: none;
        }
        #gameHUD.visible {
            display: block;
        }
        .hud-panel {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #00ffff;
            color: white;
            margin-bottom: 10px;
            min-width: 250px;
        }
        .health-bar-container {
            margin-top: 10px;
        }
        .health-bar {
            width: 100%;
            height: 25px;
            background: rgba(255, 0, 0, 0.3);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        .health-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #00ff88, #00cc66);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .health-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 5px black;
            line-height: 25px;
        }
        .ammo-display {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            margin-top: 10px;
        }
        .players-alive {
            color: #00ffff;
            font-size: 18px;
            margin-top: 10px;
        }

        /* Coin Drop Popup */
        #coinPopup {
            position: fixed;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 170, 0, 0.95));
            border: 4px solid #ffd700;
            border-radius: 15px;
            padding: 20px 30px;
            z-index: 1000;
            display: none;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }
        #coinPopup.visible {
            display: block;
            animation: popupBounce 0.5s ease;
        }
        @keyframes popupBounce {
            0% { transform: translateX(-50%) scale(0.8); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.05); }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }
        #coinPopup h3 {
            color: #000;
            margin-bottom: 10px;
            font-size: 20px;
        }
        #coinPopup p {
            color: #000;
            font-weight: bold;
            margin-bottom: 15px;
        }
        #coinPopup button {
            background: linear-gradient(135deg, #fff, #ffe);
            color: #000;
            border: 3px solid #ffd700;
            padding: 12px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
        }

        /* Winner Modal */
        #winnerModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }
        #winnerModal.visible {
            display: flex;
        }
        .winner-container {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            padding: 60px;
            border-radius: 20px;
            border: 5px solid #fff;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.8);
            text-align: center;
        }
        .winner-container h1 {
            font-size: 48px;
            color: #000;
            margin-bottom: 20px;
        }
        .winner-container p {
            font-size: 24px;
            color: #000;
            margin-bottom: 30px;
        }
        .winner-container button {
            background: #000;
            color: #ffd700;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Crosshair */
        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            pointer-events: none;
            z-index: 999;
        }
        .crosshair-line {
            position: absolute;
            background: rgba(255, 0, 0, 0.8);
        }
        .crosshair-line.h {
            width: 20px;
            height: 2px;
            left: 5px;
            top: 14px;
        }
        .crosshair-line.v {
            width: 2px;
            height: 20px;
            left: 14px;
            top: 5px;
        }
        .crosshair-center {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 0, 0, 0.8);
            left: 13px;
            top: 13px;
            border-radius: 50%;
        }

        /* Loading */
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        #loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading">
        <div class="loader"></div>
        <div class="loading-text">LOADING BATTLE ARENA...</div>
    </div>

    <!-- Wallet Connection Modal -->
    <div id="walletModal">
        <div class="wallet-container">
            <h2>üéÆ Connect to Play</h2>
            <div class="wallet-buttons">
                <button class="wallet-btn metamask" onclick="connectWallet('metamask')">
                    ü¶ä Connect MetaMask
                </button>
                <button class="wallet-btn phantom" onclick="connectWallet('phantom')">
                    üëª Connect Phantom
                </button>
                <button class="wallet-btn coinbase" onclick="connectWallet('coinbase')">
                    üíº Connect Coinbase Wallet
                </button>
            </div>

            <div class="ai-section">
                <h3>ü§ñ AI Player Mode</h3>
                <input type="text" id="apiKeyInput" placeholder="Enter Claude/OpenAI API Key">
                <button class="wallet-btn" onclick="connectAsAI()">
                    Join as AI Player
                </button>
                <p class="info-text">AI players use your API key to make decisions autonomously</p>
            </div>

            <p class="info-text">Or spectate without connecting</p>
        </div>
    </div>

    <!-- Lobby Modal -->
    <div id="lobbyModal">
        <div class="lobby-container">
            <h2>üí∞ Game Lobby</h2>

            <div class="stake-input-group">
                <label for="stakeAmount">Enter Stake Amount (ETH/SOL)</label>
                <input type="number" id="stakeAmount" placeholder="0.01" step="0.001" min="0.001" value="0.01">
                <p class="info-text">Platform fee: 5% of total pot</p>
            </div>

            <div class="color-picker-section">
                <label>Choose Robot Color</label>
                <div class="color-options">
                    <div class="color-option selected" style="background: #00ffff" data-color="0x00ffff" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ff00ff" data-color="0xff00ff" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #00ff00" data-color="0x00ff00" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ffff00" data-color="0xffff00" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ff6600" data-color="0xff6600" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ff0000" data-color="0xff0000" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #0000ff" data-color="0x0000ff" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ffffff" data-color="0xffffff" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ff1493" data-color="0xff1493" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #9370db" data-color="0x9370db" onclick="selectColor(this)"></div>
                </div>
            </div>

            <div class="players-waiting">
                <h3>Players Waiting (<span id="playerCount">0</span>/10)</h3>
                <div class="player-list" id="playerList"></div>
            </div>

            <button id="joinGameBtn" onclick="joinGame()">JOIN BATTLE</button>
            <p class="info-text">Game starts with 2+ players (max 10)</p>
        </div>
    </div>

    <!-- Game HUD -->
    <div id="gameHUD">
        <div class="hud-panel">
            <div><strong>Wallet:</strong> <span id="walletAddress">Not Connected</span></div>
            <div><strong>Balance:</strong> <span id="balance">0.00 ETH</span></div>
            <div><strong>Stake:</strong> <span id="stakeDisplay">0.00 ETH</span></div>
            <div class="health-bar-container">
                <div class="health-bar">
                    <div class="health-bar-fill" id="healthBar" style="width: 100%"></div>
                    <div class="health-text" id="healthText">100 / 100 HP</div>
                </div>
            </div>
            <div class="ammo-display">üî´ <span id="ammoCount">30</span> / ‚àû</div>
            <div class="players-alive">üë• <span id="playersAlive">10</span> players alive</div>
        </div>
    </div>

    <!-- Crosshair -->
    <div id="crosshair">
        <div class="crosshair-line h"></div>
        <div class="crosshair-line v"></div>
        <div class="crosshair-center"></div>
    </div>

    <!-- Coin Drop Popup -->
    <div id="coinPopup">
        <h3>üí∞ Dropped Coins!</h3>
        <p id="coinInfo">Player: 0x123... | Amount: 0.05 ETH</p>
        <button onclick="collectCoins()">COLLECT</button>
    </div>

    <!-- Winner Modal -->
    <div id="winnerModal">
        <div class="winner-container">
            <h1>üèÜ VICTORY! üèÜ</h1>
            <p id="winnerText">You won 0.45 ETH!</p>
            <button onclick="returnToLobby()">Return to Lobby</button>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // ==================== GAME STATE ====================
        const gameState = {
            connected: false,
            isAI: false,
            wallet: null,
            apiKey: null,
            inLobby: false,
            inGame: false,
            players: [],
            localPlayer: null,
            health: 100,
            maxHealth: 100,
            ammo: 30,
            maxAmmo: 30,
            stake: 0.01,
            collectedCoins: 0,
            nearbyCoins: null,
            robotColor: 0x00ffff
        };

        // ==================== COLOR SELECTION ====================
        window.selectColor = function(element) {
            // Remove selected from all
            document.querySelectorAll('.color-option').forEach(el => {
                el.classList.remove('selected');
            });
            // Add selected to clicked
            element.classList.add('selected');
            // Store color
            gameState.robotColor = parseInt(element.getAttribute('data-color'));
        };

        // ==================== WALLET CONNECTION ====================
        window.connectWallet = async function(walletType) {
            console.log(`Connecting to ${walletType}...`);

            try {
                let accounts;
                if (walletType === 'metamask') {
                    if (typeof window.ethereum !== 'undefined') {
                        accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        gameState.wallet = accounts[0];
                    } else {
                        alert('MetaMask not installed! This is a demo - proceeding with mock wallet.');
                        gameState.wallet = '0x' + Math.random().toString(36).substring(2, 15);
                    }
                } else if (walletType === 'phantom') {
                    if (window.solana && window.solana.isPhantom) {
                        const resp = await window.solana.connect();
                        gameState.wallet = resp.publicKey.toString();
                    } else {
                        alert('Phantom not installed! This is a demo - proceeding with mock wallet.');
                        gameState.wallet = 'Sol' + Math.random().toString(36).substring(2, 15);
                    }
                } else {
                    // Mock wallet for demo
                    gameState.wallet = '0x' + Math.random().toString(36).substring(2, 15);
                }

                gameState.connected = true;
                gameState.isAI = false;

                // Update HUD
                document.getElementById('walletAddress').textContent =
                    gameState.wallet.substring(0, 6) + '...' + gameState.wallet.substring(gameState.wallet.length - 4);

                // Hide wallet modal, show lobby
                document.getElementById('walletModal').classList.add('hidden');
                document.getElementById('lobbyModal').classList.add('visible');

                // Simulate other players in lobby
                simulateLobbyPlayers();

            } catch (error) {
                console.error('Wallet connection error:', error);
                alert('Connection failed. Using demo mode.');
                gameState.wallet = '0x' + Math.random().toString(36).substring(2, 15);
                gameState.connected = true;
                document.getElementById('walletModal').classList.add('hidden');
                document.getElementById('lobbyModal').classList.add('visible');
                simulateLobbyPlayers();
            }
        };

        window.connectAsAI = function() {
            const apiKey = document.getElementById('apiKeyInput').value;
            if (!apiKey || apiKey.length < 10) {
                alert('Please enter a valid API key');
                return;
            }

            gameState.connected = true;
            gameState.isAI = true;
            gameState.apiKey = apiKey;
            gameState.wallet = 'AI-' + Math.random().toString(36).substring(2, 10);

            document.getElementById('walletAddress').textContent = 'AI Player';
            document.getElementById('walletModal').classList.add('hidden');
            document.getElementById('lobbyModal').classList.add('visible');

            simulateLobbyPlayers();
        };

        function simulateLobbyPlayers() {
            const playerList = document.getElementById('playerList');
            const count = Math.floor(Math.random() * 5) + 1;
            gameState.players = [{
                id: gameState.wallet,
                wallet: gameState.wallet,
                isAI: gameState.isAI,
                stake: 0.01
            }];

            for (let i = 0; i < count; i++) {
                const isAI = Math.random() > 0.7;
                gameState.players.push({
                    id: (isAI ? 'AI-' : '0x') + Math.random().toString(36).substring(2, 10),
                    wallet: (isAI ? 'AI-' : '0x') + Math.random().toString(36).substring(2, 10),
                    isAI: isAI,
                    stake: 0.01
                });
            }

            updateLobbyUI();
        }

        function updateLobbyUI() {
            const playerList = document.getElementById('playerList');
            const playerCount = document.getElementById('playerCount');

            playerCount.textContent = gameState.players.length;
            playerList.innerHTML = '';

            gameState.players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item' + (player.isAI ? ' ai' : '');
                const displayName = player.isAI ?
                    'ü§ñ AI-' + player.id.substring(3, 9) :
                    player.wallet.substring(0, 6) + '...' + player.wallet.substring(player.wallet.length - 4);
                div.innerHTML = `<span>${displayName}</span><span>${player.stake} ETH</span>`;
                playerList.appendChild(div);
            });
        }

        window.joinGame = function() {
            const stakeInput = document.getElementById('stakeAmount');
            gameState.stake = parseFloat(stakeInput.value) || 0.01;
            gameState.inLobby = false;
            gameState.inGame = true;

            document.getElementById('stakeDisplay').textContent = gameState.stake + ' ETH';
            document.getElementById('lobbyModal').classList.remove('visible');
            document.getElementById('gameHUD').classList.add('visible');
            document.getElementById('playersAlive').textContent = gameState.players.length;

            // Start game
            initGame();
        };

        // ==================== GAME INITIALIZATION ====================
        let scene, camera, renderer, composer;
        let playerGroup, playerMixer;
        let gun, bullets = [];
        let otherPlayers = [];
        let coins = [];

        function initGame() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            scene.fog = new THREE.Fog(0x000000, 0, 80);

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 15);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            document.body.appendChild(renderer.domElement);

            // Post-processing
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            const bloomPass = new UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                1.5, 0.4, 0.85
            );
            composer.addPass(bloomPass);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
            mainLight.position.set(0, 80, 10);
            mainLight.castShadow = true;
            scene.add(mainLight);

            // Platform
            const platformRadius = 37.5;
            const platformGeometry = new THREE.CircleGeometry(platformRadius, 64);
            const platformMaterial = new THREE.MeshStandardMaterial({
                color: 0x1a2a3a,
                roughness: 0.3,
                metalness: 0.7
            });
            const platform = new THREE.Mesh(platformGeometry, platformMaterial);
            platform.rotation.x = -Math.PI / 2;
            platform.position.y = 0;
            platform.receiveShadow = true;
            scene.add(platform);

            // Ring
            const ringGeometry = new THREE.RingGeometry(platformRadius - 0.5, platformRadius + 0.5, 64);
            const ringMaterial = new THREE.MeshStandardMaterial({
                color: 0xff0000,
                emissive: 0xff0000,
                emissiveIntensity: 1.5,
                transparent: true,
                opacity: 0.8
            });
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.rotation.x = -Math.PI / 2;
            ring.position.y = 0.1;
            scene.add(ring);

            // Load player
            playerGroup = new THREE.Group();
            scene.add(playerGroup);

            const loader = new GLTFLoader();
            loader.load(
                'https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb',
                (gltf) => {
                    const model = gltf.scene;
                    model.scale.set(0.75, 0.75, 0.75);
                    playerGroup.add(model);

                    // Apply selected color
                    model.traverse((child) => {
                        if (child.isMesh && child.material) {
                            child.material.color.setHex(gameState.robotColor);
                            child.material.emissive.setHex(gameState.robotColor);
                            child.material.emissiveIntensity = 0.3;
                        }
                    });

                    if (gltf.animations.length) {
                        playerMixer = new THREE.AnimationMixer(model);
                        const idleClip = THREE.AnimationClip.findByName(gltf.animations, 'Idle');
                        if (idleClip) {
                            const action = playerMixer.clipAction(idleClip);
                            action.play();
                        }
                    }

                    // Add gun
                    createGun();

                    document.getElementById('loading').classList.add('hidden');
                },
                undefined,
                () => {
                    // Fallback
                    const fallback = new THREE.Mesh(
                        new THREE.CapsuleGeometry(0.5, 1.5),
                        new THREE.MeshStandardMaterial({
                            color: gameState.robotColor,
                            emissive: gameState.robotColor,
                            emissiveIntensity: 0.3
                        })
                    );
                    fallback.position.y = 1;
                    playerGroup.add(fallback);
                    createGun();
                    document.getElementById('loading').classList.add('hidden');
                }
            );

            // Spawn other players
            spawnOtherPlayers();

            // Input
            setupInput();

            // Start animation
            animate();
        }

        function createGun() {
            gun = new THREE.Group();

            // Simple gun shape
            const barrel = new THREE.Mesh(
                new THREE.CylinderGeometry(0.05, 0.05, 1, 8),
                new THREE.MeshStandardMaterial({ color: 0x333333 })
            );
            barrel.rotation.z = Math.PI / 2;
            barrel.position.x = 0.5;
            gun.add(barrel);

            const handle = new THREE.Mesh(
                new THREE.BoxGeometry(0.1, 0.3, 0.15),
                new THREE.MeshStandardMaterial({ color: 0x222222 })
            );
            handle.position.set(0, -0.15, 0);
            gun.add(handle);

            gun.position.set(0.3, 0.5, -0.3);
            playerGroup.add(gun);
        }

        function spawnOtherPlayers() {
            // Spawn other players around the platform
            gameState.players.forEach((player, index) => {
                if (player.id === gameState.wallet) return;

                const angle = (index / gameState.players.length) * Math.PI * 2;
                const radius = 20;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                // Create simple player representation
                const otherPlayer = new THREE.Group();
                const body = new THREE.Mesh(
                    new THREE.CapsuleGeometry(0.5, 1.5),
                    new THREE.MeshStandardMaterial({
                        color: player.isAI ? 0xff00ff : 0x00ffff
                    })
                );
                body.position.y = 1;
                otherPlayer.add(body);

                // Name label
                const canvas = document.createElement('canvas');
                canvas.width = 256;
                canvas.height = 64;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(player.isAI ? 'ü§ñ AI' : player.wallet.substring(0, 8), 128, 40);

                const texture = new THREE.CanvasTexture(canvas);
                const label = new THREE.Mesh(
                    new THREE.PlaneGeometry(2, 0.5),
                    new THREE.MeshBasicMaterial({ map: texture, transparent: true })
                );
                label.position.y = 3;
                otherPlayer.add(label);

                otherPlayer.position.set(x, 0, z);
                otherPlayer.userData = {
                    id: player.id,
                    health: 100,
                    isAI: player.isAI,
                    stake: player.stake
                };

                scene.add(otherPlayer);
                otherPlayers.push(otherPlayer);
            });
        }

        // ==================== INPUT ====================
        const keys = { w: false, a: false, s: false, d: false, shift: false };
        const moveSpeed = 0.15;
        let mouseDown = false;
        let shootCooldown = 0;

        function setupInput() {
            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();
                if (keys.hasOwnProperty(key)) keys[key] = true;
                if (e.key === 'Shift') keys.shift = true;
            });

            document.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                if (keys.hasOwnProperty(key)) keys[key] = false;
                if (e.key === 'Shift') keys.shift = false;
            });

            document.addEventListener('mousedown', () => { mouseDown = true; });
            document.addEventListener('mouseup', () => { mouseDown = false; });

            // Lock pointer for FPS controls
            document.addEventListener('click', () => {
                if (gameState.inGame) {
                    document.body.requestPointerLock();
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (document.pointerLockElement && gameState.inGame) {
                    camera.rotation.y -= e.movementX * 0.002;
                    camera.rotation.x -= e.movementY * 0.002;
                    camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
                }
            });
        }

        // ==================== SHOOTING ====================
        function shoot() {
            if (gameState.ammo <= 0 || shootCooldown > 0) return;

            gameState.ammo--;
            shootCooldown = 10;
            document.getElementById('ammoCount').textContent = gameState.ammo;

            // Reload
            if (gameState.ammo === 0) {
                setTimeout(() => {
                    gameState.ammo = gameState.maxAmmo;
                    document.getElementById('ammoCount').textContent = gameState.ammo;
                }, 2000);
            }

            // Create bullet
            const bullet = new THREE.Mesh(
                new THREE.SphereGeometry(0.1),
                new THREE.MeshBasicMaterial({ color: 0xffff00 })
            );

            bullet.position.copy(camera.position);
            const direction = new THREE.Vector3();
            camera.getWorldDirection(direction);
            bullet.userData.velocity = direction.multiplyScalar(2);
            bullet.userData.life = 100;

            scene.add(bullet);
            bullets.push(bullet);

            // Check hits
            checkBulletHits(bullet);
        }

        function checkBulletHits(bullet) {
            otherPlayers.forEach(player => {
                const dist = bullet.position.distanceTo(player.position);
                if (dist < 2 && player.userData.health > 0) {
                    // Hit!
                    player.userData.health -= 10;

                    if (player.userData.health <= 0) {
                        // Player died - drop coins
                        dropCoins(player);
                        player.visible = false;

                        // Update alive count
                        const alive = otherPlayers.filter(p => p.userData.health > 0).length + 1;
                        document.getElementById('playersAlive').textContent = alive;

                        if (alive === 1) {
                            // You won!
                            showVictory();
                        }
                    }
                }
            });
        }

        function dropCoins(player) {
            // Create coin drop
            const coinGroup = new THREE.Group();

            const coinGeo = new THREE.CylinderGeometry(0.5, 0.5, 0.1, 16);
            const coinMat = new THREE.MeshStandardMaterial({
                color: 0xffd700,
                emissive: 0xffaa00,
                emissiveIntensity: 0.5,
                metalness: 0.8
            });
            const coin = new THREE.Mesh(coinGeo, coinMat);
            coin.rotation.x = Math.PI / 2;
            coinGroup.add(coin);

            const light = new THREE.PointLight(0xffd700, 2, 10);
            coinGroup.add(light);

            coinGroup.position.copy(player.position);
            coinGroup.userData = {
                playerId: player.userData.id,
                amount: player.userData.stake,
                collected: false
            };

            scene.add(coinGroup);
            coins.push(coinGroup);
        }

        function checkCoinCollection() {
            coins.forEach(coin => {
                if (coin.userData.collected) return;

                const dist = playerGroup.position.distanceTo(coin.position);
                if (dist < 3) {
                    if (!gameState.nearbyCoins) {
                        // Show popup
                        gameState.nearbyCoins = coin;
                        const info = `Player: ${coin.userData.playerId.substring(0, 10)}... | Amount: ${coin.userData.amount} ETH`;
                        document.getElementById('coinInfo').textContent = info;
                        document.getElementById('coinPopup').classList.add('visible');
                    }
                } else {
                    if (gameState.nearbyCoins === coin) {
                        gameState.nearbyCoins = null;
                        document.getElementById('coinPopup').classList.remove('visible');
                    }
                }
            });
        }

        window.collectCoins = function() {
            if (gameState.nearbyCoins) {
                gameState.collectedCoins += gameState.nearbyCoins.userData.amount;
                gameState.nearbyCoins.userData.collected = true;
                scene.remove(gameState.nearbyCoins);

                document.getElementById('coinPopup').classList.remove('visible');
                document.getElementById('balance').textContent =
                    (gameState.stake + gameState.collectedCoins).toFixed(3) + ' ETH';

                gameState.nearbyCoins = null;
            }
        };

        // ==================== GAME OVER ====================
        function showVictory() {
            const totalWinnings = gameState.stake + gameState.collectedCoins;
            document.getElementById('winnerText').textContent =
                `You won ${totalWinnings.toFixed(3)} ETH!`;
            document.getElementById('winnerModal').classList.add('visible');
            gameState.inGame = false;
        }

        window.returnToLobby = function() {
            document.getElementById('winnerModal').classList.remove('visible');
            document.getElementById('gameHUD').classList.remove('visible');
            document.getElementById('lobbyModal').classList.add('visible');

            // Reset game
            gameState.health = 100;
            gameState.ammo = 30;
            gameState.collectedCoins = 0;

            // Clear scene
            otherPlayers.forEach(p => scene.remove(p));
            otherPlayers = [];
            bullets.forEach(b => scene.remove(b));
            bullets = [];
            coins.forEach(c => scene.remove(c));
            coins = [];

            simulateLobbyPlayers();
        };

        // ==================== ANIMATION LOOP ====================
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);

            if (!gameState.inGame) return;

            const delta = clock.getDelta();

            if (playerMixer) playerMixer.update(delta);

            // Player movement
            const velocity = new THREE.Vector3();
            const speed = keys.shift ? moveSpeed * 2 : moveSpeed;

            if (keys.w) velocity.z -= speed;
            if (keys.s) velocity.z += speed;
            if (keys.a) velocity.x -= speed;
            if (keys.d) velocity.x += speed;

            if (velocity.length() > 0) {
                velocity.applyEuler(new THREE.Euler(0, camera.rotation.y, 0));
                playerGroup.position.add(velocity);
            }

            // Shooting
            if (mouseDown && shootCooldown === 0) {
                shoot();
            }
            if (shootCooldown > 0) shootCooldown--;

            // Update bullets
            bullets.forEach((bullet, index) => {
                bullet.position.add(bullet.userData.velocity);
                bullet.userData.life--;

                if (bullet.userData.life <= 0) {
                    scene.remove(bullet);
                    bullets.splice(index, 1);
                }
            });

            // Animate coins
            coins.forEach(coin => {
                if (!coin.userData.collected) {
                    coin.position.y = 0.5 + Math.sin(Date.now() * 0.002) * 0.3;
                    coin.rotation.y += 0.02;
                }
            });

            // Check coin collection
            checkCoinCollection();

            // AI behavior (simple)
            otherPlayers.forEach(player => {
                if (player.userData.isAI && player.userData.health > 0) {
                    // Simple AI: move randomly, occasionally shoot
                    if (Math.random() < 0.02) {
                        const angle = Math.random() * Math.PI * 2;
                        player.position.x += Math.cos(angle) * 0.1;
                        player.position.z += Math.sin(angle) * 0.1;
                    }
                }
            });

            // Camera follows player
            camera.position.x = playerGroup.position.x;
            camera.position.z = playerGroup.position.z;
            camera.position.y = playerGroup.position.y + 1.6;

            composer.render();
        }

        // Window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
