<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PvP AI - Crypto Battle Royale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            overflow: hidden;
            color: white;
        }

        /* GLOBAL */
        .hidden { display: none !important; }
        canvas { display: block; width: 100%; height: 100vh; }

        /* LOADING */
        #loading {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }
        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
            letter-spacing: 2px;
        }

        /* WALLET MODAL - BADASS DARK THEME */
        #walletModal {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, rgba(20,0,0,0.95) 0%, rgba(0,0,0,0.98) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .wallet-container {
            background: linear-gradient(145deg, #0a0a0a 0%, #1a0000 100%);
            padding: 60px 50px;
            border-radius: 0;
            border: 1px solid #ff0000;
            box-shadow: 0 0 100px rgba(255,0,0,0.3), inset 0 0 50px rgba(0,0,0,0.8);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .wallet-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ff0000, transparent);
        }
        .wallet-header {
            text-align: center;
            margin-bottom: 50px;
            position: relative;
        }
        .wallet-header h1 {
            font-size: 42px;
            font-weight: 900;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: #fff;
            text-shadow: 0 0 20px rgba(255,0,0,0.8), 0 0 40px rgba(255,0,0,0.4);
            margin-bottom: 10px;
            font-family: 'Arial Black', sans-serif;
        }
        .wallet-header p {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        .chain-selector {
            margin-bottom: 40px;
        }
        .chain-selector h3 {
            color: #fff;
            margin-bottom: 20px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 700;
            border-left: 3px solid #ff0000;
            padding-left: 15px;
        }
        .chain-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .chain-card {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .chain-card:hover {
            border-color: #ff0000;
            background: #1a0000;
            transform: scale(1.05);
        }
        .chain-card.selected {
            border-color: #ff0000;
            background: #1a0000;
            box-shadow: 0 0 20px rgba(255,0,0,0.4);
        }
        .chain-icon {
            font-size: 28px;
            margin-bottom: 5px;
        }
        .chain-name {
            font-weight: 700;
            color: white;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .wallet-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 35px;
        }
        .wallet-btn {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 20px 30px;
            border-radius: 0;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }
        .wallet-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: #ff0000;
            transition: width 0.3s;
            z-index: 0;
        }
        .wallet-btn:hover:not(:disabled)::before {
            width: 100%;
        }
        .wallet-btn:hover:not(:disabled) {
            border-color: #ff0000;
            box-shadow: 0 0 30px rgba(255,0,0,0.3);
        }
        .wallet-btn span {
            position: relative;
            z-index: 1;
        }
        .wallet-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .wallet-btn.metamask:hover::before { background: #f6851b; }
        .wallet-btn.phantom:hover::before { background: #ab9ff2; }
        .wallet-btn.coinbase:hover::before { background: #0052ff; }

        .ai-section {
            border-top: 2px solid rgba(255,255,255,0.1);
            padding-top: 30px;
            margin-top: 30px;
        }
        .ai-section h3 {
            color: #ff00ff;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
        }
        .ai-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ff00ff;
            border-radius: 10px;
            background: rgba(255,0,255,0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .ai-input::placeholder { color: rgba(255,255,255,0.5); }

        .info-box {
            background: #0a0a0a;
            border: 1px solid #333;
            border-left: 3px solid #ff0000;
            border-radius: 0;
            padding: 20px;
            margin-top: 30px;
        }
        .info-box p {
            color: rgba(255,255,255,0.6);
            font-size: 11px;
            line-height: 1.8;
            margin: 5px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .info-box strong { color: #00ccff; }

        .error-box {
            background: rgba(255,0,0,0.1);
            border: 1px solid rgba(255,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        .error-box p {
            color: #ff6666;
            font-size: 14px;
            line-height: 1.5;
        }

        /* DASHBOARD */
        #dashboard {
            position: fixed;
            inset: 0;
            background: #000;
            overflow-y: auto;
            z-index: 9998;
        }
        .dashboard-header {
            background: #0a0a0a;
            padding: 25px 40px;
            border-bottom: 1px solid #ff0000;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
        }
        .dashboard-header h1 {
            font-size: 28px;
            color: #fff;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 4px;
            font-weight: 900;
            text-shadow: 0 0 20px rgba(255,0,0,0.5);
        }
        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: #1a0000;
            padding: 8px 20px;
            border-radius: 0;
            border: 1px solid #ff0000;
            border-left: 3px solid #ff0000;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            background: #ff0000;
            border-radius: 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px #ff0000; }
            50% { opacity: 0.4; box-shadow: 0 0 5px #ff0000; }
        }

        .dashboard-content {
            padding: 40px;
            max-width: 1600px;
            margin: 0 auto;
        }
        .section-title {
            font-size: 12px;
            color: #fff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 700;
            border-left: 3px solid #ff0000;
            padding-left: 15px;
        }

        .create-game-card {
            background: #0a0a0a;
            border: 1px solid #333;
            border-left: 3px solid #ff0000;
            border-radius: 0;
            padding: 30px;
            margin-bottom: 40px;
        }
        .stake-input-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            color: rgba(255,255,255,0.6);
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .stake-input {
            width: 100%;
            padding: 18px;
            border: 1px solid #333;
            border-radius: 0;
            background: #000;
            color: white;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            font-family: 'Courier New', monospace;
        }
        .color-picker {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(45px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .color-btn {
            aspect-ratio: 1;
            border-radius: 0;
            border: 2px solid #333;
            cursor: pointer;
            transition: all 0.2s;
        }
        .color-btn:hover { transform: scale(1.1); border-color: #ff0000; }
        .color-btn.selected {
            border-color: #ff0000;
            box-shadow: 0 0 15px rgba(255,0,0,0.6);
        }

        .create-btn {
            width: 100%;
            padding: 20px;
            background: #ff0000;
            border: none;
            border-radius: 0;
            color: #fff;
            font-size: 16px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 3px;
            position: relative;
            overflow: hidden;
        }
        .create-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            transition: left 0.3s;
        }
        .create-btn:hover::before {
            left: 100%;
        }
        .create-btn:hover {
            box-shadow: 0 0 30px rgba(255,0,0,0.6);
        }

        .lobby-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
        }
        .lobby-card {
            background: #0a0a0a;
            border: 1px solid #333;
            border-left: 3px solid #ff0000;
            border-radius: 0;
            padding: 20px;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }
        .lobby-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: rgba(255,0,0,0.05);
            transition: width 0.3s;
            z-index: 0;
        }
        .lobby-card:hover::before {
            width: 100%;
        }
        .lobby-card:hover {
            border-color: #ff0000;
            box-shadow: 0 0 20px rgba(255,0,0,0.2);
        }
        .lobby-card.full {
            opacity: 0.4;
            cursor: not-allowed;
            border-left-color: #666;
        }
        .lobby-card > * {
            position: relative;
            z-index: 1;
        }
        .lobby-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .lobby-id {
            font-size: 14px;
            color: rgba(255,255,255,0.6);
        }
        .lobby-status {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        .lobby-status.waiting {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
        }
        .lobby-status.active {
            background: rgba(0,255,0,0.2);
            color: #00ff00;
        }
        .lobby-status.full {
            background: rgba(255,0,0,0.2);
            color: #ff6666;
        }
        .lobby-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
        }
        .stat-label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #ff0000;
            font-family: 'Courier New', monospace;
        }
        .join-lobby-btn {
            width: 100%;
            padding: 15px;
            background: #ff0000;
            border: none;
            border-radius: 0;
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .join-lobby-btn:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
        }
        .join-lobby-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .logout-section {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 1px solid #333;
        }
        .logout-btn {
            padding: 15px 30px;
            background: #000;
            border: 1px solid #ff0000;
            border-radius: 0;
            color: #ff0000;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .logout-btn:hover {
            background: #ff0000;
            color: #fff;
        }

        /* GAME HUD - MINIMAL */
        #gameHUD {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 1000;
            font-family: 'Courier New', monospace;
        }
        .hud-panel {
            background: none;
            border: none;
            padding: 0;
            margin-bottom: 15px;
        }
        .hud-row {
            display: block;
            margin: 0;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        .hud-label {
            display: none;
        }
        .hud-value {
            color: #fff;
            font-weight: 900;
            font-family: 'Courier New', monospace;
        }
        .health-bar-container { margin-top: 15px; }
        .health-bar {
            width: 100%;
            height: 32px;
            background: rgba(255,0,0,0.3);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            border: 2px solid rgba(255,0,0,0.5);
        }
        .health-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #00ff88, #00cc66);
            transition: width 0.3s;
        }
        .health-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            text-shadow: 0 0 10px black;
        }
        .ammo-display {
            font-size: 32px;
            font-weight: 700;
            color: #ffd700;
            text-align: center;
            margin-top: 15px;
        }
        .players-alive {
            font-size: 20px;
            font-weight: 700;
            color: #00ccff;
            text-align: center;
            margin-top: 12px;
        }

        /* CROSSHAIR */
        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 998;
        }
        .crosshair-line {
            position: absolute;
            background: white;
            box-shadow: 0 0 5px black;
        }
        .crosshair-h {
            width: 30px;
            height: 2px;
            top: 19px;
            left: 5px;
        }
        .crosshair-v {
            width: 2px;
            height: 30px;
            top: 5px;
            left: 19px;
        }
        .crosshair-dot {
            width: 5px;
            height: 5px;
            background: #ff0000;
            border-radius: 50%;
            position: absolute;
            top: 17.5px;
            left: 17.5px;
            box-shadow: 0 0 5px black;
        }

        /* KILL FEED */
        #killFeed {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        .kill-msg {
            background: rgba(0,0,0,0.9);
            padding: 12px 18px;
            border-radius: 8px;
            border-left: 4px solid #ff0000;
            color: white;
            font-size: 14px;
            animation: slideIn 0.3s, fadeOut 0.5s 4.5s forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }

        /* COIN POPUP */
        #coinPopup {
            position: fixed;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border: 4px solid #ffd700;
            border-radius: 15px;
            padding: 25px 35px;
            z-index: 1000;
            text-align: center;
            min-width: 350px;
            box-shadow: 0 0 50px rgba(255,215,0,0.8);
        }
        #coinPopup h3 {
            color: #000;
            font-size: 24px;
            margin-bottom: 12px;
        }
        #coinPopup p {
            color: #000;
            font-weight: 600;
            margin-bottom: 18px;
            font-size: 15px;
        }
        #coinPopup button {
            background: #000;
            color: #ffd700;
            border: none;
            padding: 15px 45px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #coinPopup button:hover {
            transform: scale(1.05);
        }

        /* MODALS */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }
        .modal-content {
            padding: 60px;
            border-radius: 20px;
            text-align: center;
            animation: modalAppear 0.5s;
        }
        @keyframes modalAppear {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .winner-modal {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border: 5px solid white;
            box-shadow: 0 0 80px rgba(255,215,0,0.9);
        }
        .winner-modal h1 {
            font-size: 56px;
            color: #000;
            margin-bottom: 20px;
        }
        .winnings-display {
            font-size: 36px;
            font-weight: 700;
            color: #000;
            margin: 20px 0;
        }
        .breakdown-box {
            background: rgba(0,0,0,0.1);
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
        }
        .breakdown-box p {
            color: #000;
            margin: 8px 0;
            font-size: 16px;
        }
        .modal-btn {
            background: #000;
            color: #ffd700;
            border: none;
            padding: 18px 50px;
            font-size: 20px;
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        .modal-btn:hover {
            transform: scale(1.05);
        }

        .defeat-modal {
            background: linear-gradient(135deg, #8b0000, #ff0000);
            border: 5px solid white;
            box-shadow: 0 0 80px rgba(255,0,0,0.8);
        }
        .defeat-modal h1 {
            font-size: 52px;
            color: white;
            margin-bottom: 20px;
        }
        .defeat-modal p {
            font-size: 20px;
            color: white;
            margin: 15px 0;
        }
        .defeat-modal .modal-btn {
            background: white;
            color: #8b0000;
        }

        /* INSTRUCTIONS */
        #instructions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 15px 35px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            font-size: 15px;
            z-index: 999;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            .wallet-container,
            .modal-content {
                padding: 30px 20px;
            }
            .lobby-grid {
                grid-template-columns: 1fr;
            }
            .dashboard-content {
                padding: 20px;
            }
        }
    </style>

    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Backend Connector -->
    <script src="backend-connector.js"></script>
</head>
<body>
    <div id="loading">
        <div class="loader"></div>
        <div class="loading-text">INITIALIZING BATTLE ARENA...</div>
    </div>

    <div id="walletModal">
        <div class="wallet-container">
            <div class="wallet-header">
                <h1>PvP AI</h1>
                <p>Crypto-Powered Battle Royale</p>
            </div>

            <div class="chain-selector">
                <h3>Select Blockchain</h3>
                <div class="chain-grid">
                    <div class="chain-card selected" data-chain="eth" data-token="ETH" onclick="selectChain(this)">
                        <div class="chain-icon">‚ü†</div>
                        <div class="chain-name">Ethereum</div>
                    </div>
                    <div class="chain-card" data-chain="sol" data-token="SOL" onclick="selectChain(this)">
                        <div class="chain-icon">‚óé</div>
                        <div class="chain-name">Solana</div>
                    </div>
                    <div class="chain-card" data-chain="base" data-token="ETH" onclick="selectChain(this)">
                        <div class="chain-icon">üîµ</div>
                        <div class="chain-name">Base</div>
                    </div>
                    <div class="chain-card" data-chain="polygon" data-token="MATIC" onclick="selectChain(this)">
                        <div class="chain-icon">üü£</div>
                        <div class="chain-name">Polygon</div>
                    </div>
                </div>
            </div>

            <div class="wallet-buttons">
                <button class="wallet-btn metamask" onclick="connectWallet('metamask')">
                    ü¶ä Connect MetaMask
                </button>
                <button class="wallet-btn phantom" onclick="connectWallet('phantom')">
                    üëª Connect Phantom
                </button>
                <button class="wallet-btn coinbase" onclick="connectWallet('coinbase')">
                    üíº Connect Coinbase Wallet
                </button>
            </div>

            <div class="ai-section">
                <h3>ü§ñ AI Bot Mode</h3>
                <input type="text" class="ai-input" id="apiKeyInput" placeholder="Enter Claude or OpenAI API Key">
                <button class="wallet-btn" onclick="connectAsAI()">
                    Join as AI Bot
                </button>
            </div>

            <div class="info-box">
                <p><strong>‚ö†Ô∏è PROTOTYPE NOTE:</strong></p>
                <p>‚Ä¢ This is a client-side prototype</p>
                <p>‚Ä¢ Real wallet required (no mock mode)</p>
                <p>‚Ä¢ Multiplayer simulated locally</p>
                <p>‚Ä¢ Production requires backend server</p>
            </div>

            <div id="walletError" class="error-box hidden">
                <p id="walletErrorText"></p>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="dashboard-header">
            <h1>Battle Dashboard</h1>
            <div class="user-badge">
                <div class="status-dot"></div>
                <span id="userDisplay">Connected</span>
            </div>
        </div>

        <div class="dashboard-content">
            <div class="section-title">
                <span>üéÆ</span>
                <span>Create New Game</span>
            </div>

            <div class="create-game-card">
                <div class="stake-input-row">
                    <div class="input-group">
                        <label for="stakeAmount">Stake Amount</label>
                        <input type="number" id="stakeAmount" class="stake-input" value="0.01" step="0.001" min="0.001">
                    </div>
                    <div class="input-group">
                        <label>Token</label>
                        <input type="text" id="tokenDisplay" class="stake-input" readonly value="ETH" style="max-width:150px">
                    </div>
                </div>

                <div class="input-group">
                    <label>üé® Robot Color</label>
                    <div class="color-picker">
                        <div class="color-btn selected" style="background:#00ffff" data-color="0x00ffff" onclick="selectColor(this)"></div>
                        <div class="color-btn" style="background:#ff00ff" data-color="0xff00ff" onclick="selectColor(this)"></div>
                        <div class="color-btn" style="background:#00ff00" data-color="0x00ff00" onclick="selectColor(this)"></div>
                        <div class="color-btn" style="background:#ffff00" data-color="0xffff00" onclick="selectColor(this)"></div>
                        <div class="color-btn" style="background:#ff6600" data-color="0xff6600" onclick="selectColor(this)"></div>
                        <div class="color-btn" style="background:#ff0000" data-color="0xff0000" onclick="selectColor(this)"></div>
                        <div class="color-btn" style="background:#0000ff" data-color="0x0000ff" onclick="selectColor(this)"></div>
                        <div class="color-btn" style="background:#ffffff" data-color="0xffffff" onclick="selectColor(this)"></div>
                        <div class="color-btn" style="background:#ff1493" data-color="0xff1493" onclick="selectColor(this)"></div>
                        <div class="color-btn" style="background:#9370db" data-color="0x9370db" onclick="selectColor(this)"></div>
                    </div>
                </div>

                <button class="create-btn" onclick="createGame()">‚öîÔ∏è Create & Join Game</button>
            </div>

            <div class="section-title">
                <span>üèüÔ∏è</span>
                <span>Active Lobbies (<span id="lobbyCount">0</span>)</span>
            </div>

            <div class="lobby-grid" id="lobbyGrid">
                <!-- Lobbies populated by JS -->
            </div>

            <div class="logout-section">
                <button class="logout-btn" onclick="logout()">
                    üö™ Disconnect Wallet
                </button>
            </div>
        </div>
    </div>

    <div id="gameHUD" class="hidden">
        <div class="hud-panel">
            <div class="hud-row">
                <span class="hud-value">$<span id="hudCollected">0.00</span></span>
            </div>
            <div class="hud-row">
                <span class="hud-value"><span id="playersAlive">10</span> ALIVE</span>
            </div>
        </div>
    </div>

    <div id="crosshair" class="hidden">
        <div class="crosshair-line crosshair-h"></div>
        <div class="crosshair-line crosshair-v"></div>
        <div class="crosshair-dot"></div>
    </div>

    <div id="killFeed"></div>

    <div id="coinPopup" class="hidden">
        <h3>üí∞ Coins Dropped!</h3>
        <p id="coinInfo"></p>
        <button onclick="collectCoins()">COLLECT</button>
    </div>

    <div id="winnerModal" class="modal hidden">
        <div class="modal-content winner-modal">
            <h1>üèÜ VICTORY ROYALE! üèÜ</h1>
            <div class="winnings-display" id="totalWinnings"></div>
            <div class="breakdown-box">
                <p><strong>Breakdown:</strong></p>
                <p>Your Stake: <span id="yourStake"></span></p>
                <p>Eliminated Players: <span id="collectedAmount"></span></p>
                <p>Platform Fee (5%): <span id="platformFee"></span></p>
                <p><strong>Net Profit: <span id="netProfit"></span></strong></p>
            </div>
            <button class="modal-btn" onclick="returnToDashboard()">Return to Dashboard</button>
            <button class="modal-btn" onclick="logout()">Disconnect & Exit</button>
        </div>
    </div>

    <div id="defeatModal" class="modal hidden">
        <div class="modal-content defeat-modal">
            <h1>üíÄ DEFEATED üíÄ</h1>
            <p id="defeatMessage"></p>
            <p>Better luck next time!</p>
            <button class="modal-btn" onclick="returnToDashboard()">Return to Dashboard</button>
        </div>
    </div>

    <div id="instructions" class="hidden">
        <strong>WASD</strong> Move | <strong>Mouse</strong> Look | <strong>Click</strong> Shoot | <strong>ESC</strong> Pause
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FXAAShader } from 'three/addons/shaders/FXAAShader.js';
        import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';

        // ==================== STATE ====================
        const gameState = {
            wallet: null,
            chain: 'eth',
            token: 'ETH',
            isAI: false,
            apiKey: null,
            inGame: false,
            stake: 0.01,
            collected: 0,
            health: 100,
            maxHealth: 100,
            ammo: 30,
            maxAmmo: 30,
            robotColor: 0x00ffff,
            kills: 0,
            lobbies: [],
            currentLobby: null,
            nearbyCoins: null
        };

        let scene, camera, renderer, composer, clock;
        let playerGroup, playerModel, playerMixer, gun, muzzleFlash;
        let otherPlayers = [], bullets = [], coins = [];
        let keys = { w: false, a: false, s: false, d: false, shift: false };
        let mouseX = 0, mouseY = 0, mouseDown = false, shootCooldown = 0;
        const moveSpeed = 0.25;

        // ==================== WALLET CONNECTION ====================
        window.selectChain = function(el) {
            document.querySelectorAll('.chain-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            gameState.chain = el.dataset.chain;
            gameState.token = el.dataset.token;
        };

        window.connectWallet = async function(type) {
            const errorBox = document.getElementById('walletError');
            const errorText = document.getElementById('walletErrorText');

            try {
                let wallet;

                if (type === 'metamask') {
                    if (typeof window.ethereum === 'undefined') {
                        throw new Error('MetaMask not installed. Please install MetaMask extension.');
                    }
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    wallet = accounts[0];

                    // Verify chain
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    console.log('Connected to chain:', chainId);

                } else if (type === 'phantom') {
                    if (!window.solana || !window.solana.isPhantom) {
                        throw new Error('Phantom wallet not installed. Please install Phantom extension.');
                    }
                    const resp = await window.solana.connect();
                    wallet = resp.publicKey.toString();

                } else if (type === 'coinbase') {
                    throw new Error('Coinbase Wallet integration coming soon. Use MetaMask or Phantom.');
                }

                gameState.wallet = wallet;
                proceedToDashboard();

            } catch (error) {
                console.error('Wallet connection error:', error);
                errorText.textContent = error.message;
                errorBox.classList.remove('hidden');
            }
        };

        window.connectAsAI = function() {
            const apiKey = document.getElementById('apiKeyInput').value;
            if (!apiKey || apiKey.length < 20) {
                alert('Please enter a valid API key (minimum 20 characters)');
                return;
            }

            gameState.wallet = 'AI-' + Math.random().toString(36).substring(2, 14);
            gameState.isAI = true;
            gameState.apiKey = apiKey;

            proceedToDashboard();
        };

        function proceedToDashboard() {
            document.getElementById('walletModal').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('tokenDisplay').value = gameState.token;

            const displayWallet = gameState.isAI ?
                'ü§ñ AI Bot' :
                gameState.wallet.substring(0, 6) + '...' + gameState.wallet.substring(gameState.wallet.length - 4);
            document.getElementById('userDisplay').textContent = displayWallet + ' (' + gameState.token + ')';

            loadLobbies();
            document.getElementById('loading').classList.add('hidden');
        }

        // ==================== COLOR SELECTION ====================
        window.selectColor = function(el) {
            document.querySelectorAll('.color-btn').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            gameState.robotColor = parseInt(el.dataset.color);
        };

        // ==================== LOBBIES ====================
        async function loadLobbies() {
            try {
                console.log('üì° Fetching lobbies from backend...');
                const lobbies = await fetchLobbies();
                gameState.lobbies = lobbies;
                console.log('‚úÖ Loaded', lobbies.length, 'lobbies');
                renderLobbies();
            } catch (error) {
                console.error('‚ùå Error loading lobbies:', error);
                gameState.lobbies = [];
                renderLobbies();
            }
        }

        function renderLobbies() {
            const grid = document.getElementById('lobbyGrid');
            const count = document.getElementById('lobbyCount');

            count.textContent = gameState.lobbies.length;
            grid.innerHTML = '';

            gameState.lobbies.forEach(lobby => {
                const card = document.createElement('div');
                card.className = `lobby-card ${lobby.status}`;
                card.onclick = () => lobby.status !== 'full' && joinLobby(lobby);

                card.innerHTML = `
                    <div class="lobby-header-row">
                        <span class="lobby-id">${lobby.id}</span>
                        <span class="lobby-status ${lobby.status}">
                            ${lobby.status.toUpperCase()}
                        </span>
                    </div>
                    <div class="lobby-stats">
                        <div class="stat-box">
                            <div class="stat-label">Players</div>
                            <div class="stat-value">${lobby.players}/${lobby.maxPlayers}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Total Pot</div>
                            <div class="stat-value">${lobby.totalPot} ${lobby.token}</div>
                        </div>
                    </div>
                    <button class="join-lobby-btn" ${lobby.status === 'full' ? 'disabled' : ''}>
                        ${lobby.status === 'full' ? 'FULL' : 'JOIN BATTLE'}
                    </button>
                `;

                grid.appendChild(card);
            });
        }

        window.createGame = function() {
            gameState.stake = parseFloat(document.getElementById('stakeAmount').value) || 0.01;
            gameState.currentLobby = {
                id: 'LOBBY-' + Math.random().toString(36).substring(2, 8).toUpperCase(),
                players: 1,
                maxPlayers: 10
            };
            startGame();
        };

        function joinLobby(lobby) {
            gameState.stake = 0.01;
            gameState.currentLobby = lobby;
            startGame();
        }

        function startGame() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('gameHUD').classList.remove('hidden');
            document.getElementById('crosshair').classList.remove('hidden');
            document.getElementById('instructions').classList.remove('hidden');

            gameState.inGame = true;
            gameState.health = 100;
            gameState.collected = 0;
            gameState.kills = 0;

            // Update HUD
            const displayWallet = gameState.isAI ?
                'ü§ñ AI' :
                gameState.wallet.substring(0, 6) + '...';
            document.getElementById('hudWallet').textContent = displayWallet;
            document.getElementById('hudStake').textContent = gameState.stake.toFixed(3) + ' ' + gameState.token;
            document.getElementById('hudCollected').textContent = '+0.00 ' + gameState.token;

            initGame();
        }

        window.logout = function() {
            if (gameState.inGame && !confirm('Exit game? You will keep earnings collected.')) return;

            location.reload();
        };

        window.returnToDashboard = function() {
            gameState.inGame = false;
            gameState.health = 100;
            gameState.collected = 0;

            document.getElementById('gameHUD').classList.add('hidden');
            document.getElementById('crosshair').classList.add('hidden');
            document.getElementById('instructions').classList.add('hidden');
            document.getElementById('winnerModal').classList.add('hidden');
            document.getElementById('defeatModal').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            // Cleanup scene
            if (scene) {
                otherPlayers.forEach(p => scene.remove(p));
                bullets.forEach(b => scene.remove(b));
                coins.forEach(c => scene.remove(c));
                otherPlayers = [];
                bullets = [];
                coins = [];
            }

            loadLobbies();
        };

        // ==================== GAME INIT ====================
        function initGame() {
            // Initialize backend connection
            console.log('üöÄ Initializing backend connection...');
            initBackendConnection();

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            scene.fog = new THREE.Fog(0x000000, 0, 100);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 25);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            document.body.appendChild(renderer.domElement);

            // Post-processing
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85));
            const fxaaPass = new ShaderPass(FXAAShader);
            const pr = renderer.getPixelRatio();
            fxaaPass.material.uniforms['resolution'].value.x = 1 / (window.innerWidth * pr);
            fxaaPass.material.uniforms['resolution'].value.y = 1 / (window.innerHeight * pr);
            composer.addPass(fxaaPass);

            // Lighting
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 0.6));

            const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
            mainLight.position.set(0, 80, 10);
            mainLight.castShadow = true;
            mainLight.shadow.camera.left = -70;
            mainLight.shadow.camera.right = 70;
            mainLight.shadow.camera.top = 70;
            mainLight.shadow.camera.bottom = -70;
            mainLight.shadow.mapSize.setScalar(2048);
            scene.add(mainLight);

            [[40,10,40,0xff00ff],[-40,10,-40,0x00ffff],[-40,10,40,0xff3366],[40,10,-40,0x00ff88]].forEach(([x,y,z,c]) => {
                const light = new THREE.PointLight(c, 3, 60);
                light.position.set(x, y, z);
                scene.add(light);
            });

            createPlatform();
            loadPlayer();
            spawnOtherPlayers();
            setupInput();

            clock = new THREE.Clock();
            animate();
        }

        function createPlatform() {
            const r = 37.5;

            // Hexagonal texture
            const canvas = document.createElement('canvas');
            canvas.width = canvas.height = 2048;
            const ctx = canvas.getContext('2d');

            const grad = ctx.createRadialGradient(1024,1024,0,1024,1024,1024);
            grad.addColorStop(0,'#1a2a3a');
            grad.addColorStop(0.5,'#0f1520');
            grad.addColorStop(1,'#050a10');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,2048,2048);

            const hs = 60, hh = hs * Math.sqrt(3);
            for(let row=-2; row<32; row++) {
                for(let col=-2; col<32; col++) {
                    const x = col*hs*1.5, y = row*hh + (col%2)*(hh/2);
                    ctx.strokeStyle='#00d9ff';
                    ctx.lineWidth=2;
                    ctx.globalAlpha=0.6;
                    ctx.shadowBlur=10;
                    ctx.shadowColor='#00d9ff';
                    ctx.beginPath();
                    for(let i=0;i<6;i++) {
                        const a=(Math.PI/3)*i, hx=x+Math.cos(a)*hs, hy=y+Math.sin(a)*hs;
                        i?ctx.lineTo(hx,hy):ctx.moveTo(hx,hy);
                    }
                    ctx.closePath();
                    ctx.stroke();
                }
            }

            const tex = new THREE.CanvasTexture(canvas);
            const platform = new THREE.Mesh(
                new THREE.CircleGeometry(r, 64),
                new THREE.MeshStandardMaterial({
                    map:tex, roughness:0.3, metalness:0.7,
                    emissive:0x002244, emissiveMap:tex, emissiveIntensity:0.5
                })
            );
            platform.rotation.x = -Math.PI/2;
            platform.receiveShadow = true;
            scene.add(platform);

            // Ring
            const ring = new THREE.Mesh(
                new THREE.RingGeometry(r-0.5,r+0.5,64),
                new THREE.MeshStandardMaterial({
                    color:0xff0000, emissive:0xff0000, emissiveIntensity:1.5,
                    transparent:true, opacity:0.8
                })
            );
            ring.rotation.x = -Math.PI/2;
            ring.position.y = 0.1;
            scene.add(ring);

            for(let i=0;i<16;i++) {
                const a = (i/16)*Math.PI*2;
                const light = new THREE.PointLight(0xff0000, 0.5, 10);
                light.position.set(Math.cos(a)*r, 0.5, Math.sin(a)*r);
                scene.add(light);
            }

            // Particles
            const pc = 500, pg = new THREE.BufferGeometry(), pos = new Float32Array(pc*3);
            for(let i=0;i<pc;i++) {
                pos[i*3] = (Math.random()-0.5)*80;
                pos[i*3+1] = Math.random()*50;
                pos[i*3+2] = (Math.random()-0.5)*80;
            }
            pg.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            scene.add(new THREE.Points(pg, new THREE.PointsMaterial({
                color:0xffffff, size:0.1, transparent:true, opacity:0.6, blending:THREE.AdditiveBlending
            })));
        }

        function loadPlayer() {
            playerGroup = new THREE.Group();
            scene.add(playerGroup);

            new GLTFLoader().load(
                'https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb',
                gltf => {
                    playerModel = gltf.scene;
                    playerModel.scale.setScalar(0.75);
                    playerModel.traverse(c => {
                        if(c.isMesh && c.material) {
                            // Only color accents, keep body metallic
                            const isAccent = c.name && (
                                c.name.includes('Chest') ||
                                c.name.includes('Shoulder') ||
                                c.name.includes('Eye') ||
                                c.name.includes('Light') ||
                                c.name.includes('Accent')
                            );

                            if(isAccent) {
                                c.material.color.setHex(gameState.robotColor);
                                c.material.emissive.setHex(gameState.robotColor);
                                c.material.emissiveIntensity = 0.5;
                            } else {
                                c.material.color.setHex(0x444444);
                                c.material.metalness = 0.8;
                                c.material.roughness = 0.3;
                            }
                            c.castShadow = c.receiveShadow = true;
                        }
                    });
                    playerGroup.add(playerModel);

                    // Enable all animations
                    if(gltf.animations.length) {
                        playerMixer = new THREE.AnimationMixer(playerModel);
                        gltf.animations.forEach(clip => {
                            const action = playerMixer.clipAction(clip);
                            if(clip.name === 'Idle' || clip.name === 'idle') {
                                action.play();
                            }
                        });
                    }

                    createGun();
                },
                undefined,
                () => {
                    const fb = new THREE.Mesh(
                        new THREE.CapsuleGeometry(0.5,1.5),
                        new THREE.MeshStandardMaterial({
                            color:gameState.robotColor,
                            emissive:gameState.robotColor,
                            emissiveIntensity:0.3
                        })
                    );
                    fb.position.y = 1;
                    fb.castShadow = true;
                    playerGroup.add(fb);
                    createGun();
                }
            );
        }

        function createGun() {
            gun = new THREE.Group();

            const body = new THREE.Mesh(
                new THREE.BoxGeometry(0.2,0.15,0.6),
                new THREE.MeshStandardMaterial({color:0x222222, metalness:0.8, roughness:0.3})
            );
            body.position.z = -0.2;
            gun.add(body);

            const barrel = new THREE.Mesh(
                new THREE.CylinderGeometry(0.04,0.04,0.8,8),
                new THREE.MeshStandardMaterial({color:0x333333, metalness:0.9, roughness:0.2})
            );
            barrel.rotation.z = Math.PI/2;
            barrel.position.set(0.4,0.05,-0.2);
            gun.add(barrel);

            const handle = new THREE.Mesh(
                new THREE.BoxGeometry(0.12,0.35,0.2),
                new THREE.MeshStandardMaterial({color:0x1a1a1a, roughness:0.7})
            );
            handle.position.set(0,-0.2,0);
            gun.add(handle);

            muzzleFlash = new THREE.Mesh(
                new THREE.PlaneGeometry(0.3,0.3),
                new THREE.MeshBasicMaterial({
                    color:0xffff00, transparent:true, opacity:0, blending:THREE.AdditiveBlending
                })
            );
            muzzleFlash.position.set(0.8,0.05,-0.2);
            gun.add(muzzleFlash);

            gun.position.set(0.4,0.8,-0.5);
            gun.rotation.y = Math.PI/2;
            playerGroup.add(gun);
        }

        function spawnOtherPlayers() {
            const playerCount = Math.min(9, Math.floor(Math.random()*6)+3);
            const colors = [0x00ffff,0xff00ff,0x00ff00,0xffff00,0xff6600,0xff0000,0x0000ff,0xffffff,0xff1493,0x9370db];

            for(let i=0; i<playerCount; i++) {
                const angle = (i/playerCount)*Math.PI*2, r = 25;
                const otherPlayer = new THREE.Group();

                const body = new THREE.Mesh(
                    new THREE.CapsuleGeometry(0.5,1.5),
                    new THREE.MeshStandardMaterial({
                        color:colors[i%colors.length],
                        emissive:colors[i%colors.length],
                        emissiveIntensity:0.3
                    })
                );
                body.position.y = 1;
                body.castShadow = true;
                otherPlayer.add(body);

                // Health bar
                const hbg = new THREE.Mesh(
                    new THREE.PlaneGeometry(1.5,0.15),
                    new THREE.MeshBasicMaterial({color:0x330000})
                );
                hbg.position.y = 2.5;
                otherPlayer.add(hbg);

                const hfg = new THREE.Mesh(
                    new THREE.PlaneGeometry(1.5,0.15),
                    new THREE.MeshBasicMaterial({color:0x00ff00})
                );
                hfg.position.set(0,2.5,0.01);
                otherPlayer.add(hfg);

                otherPlayer.position.set(Math.cos(angle)*r, 0, Math.sin(angle)*r);
                otherPlayer.userData = {
                    id: 'Player-'+i,
                    health: 100,
                    maxHealth: 100,
                    healthBar: hfg,
                    stake: 0.01,
                    isAI: Math.random()>0.4
                };

                scene.add(otherPlayer);
                otherPlayers.push(otherPlayer);
            }

            document.getElementById('playersAlive').textContent = otherPlayers.length + 1;
        }

        // ==================== INPUT ====================
        function setupInput() {
            document.addEventListener('keydown', e => {
                const k = e.key.toLowerCase();
                if(keys.hasOwnProperty(k)) keys[k]=true;
                if(e.key==='Shift') keys.shift=true;
                if(e.key==='Escape' && document.pointerLockElement) document.exitPointerLock();
            });

            document.addEventListener('keyup', e => {
                const k = e.key.toLowerCase();
                if(keys.hasOwnProperty(k)) keys[k]=false;
                if(e.key==='Shift') keys.shift=false;
            });

            document.addEventListener('mousedown', () => mouseDown=true);
            document.addEventListener('mouseup', () => mouseDown=false);

            document.addEventListener('click', () => {
                if(gameState.inGame && !document.pointerLockElement) {
                    document.body.requestPointerLock();
                }
            });

            document.addEventListener('mousemove', e => {
                if(document.pointerLockElement) {
                    mouseX += e.movementX * 0.002;
                    mouseY -= e.movementY * 0.002;
                    mouseY = Math.max(-Math.PI/2, Math.min(Math.PI/2, mouseY));
                }
            });
        }

        // ==================== SHOOTING ====================
        function shoot() {
            if(gameState.ammo<=0 || shootCooldown>0) return;

            gameState.ammo--;
            shootCooldown = 5;
            document.getElementById('ammoCount').textContent = gameState.ammo;

            if(muzzleFlash) {
                muzzleFlash.material.opacity = 1;
                setTimeout(() => muzzleFlash && (muzzleFlash.material.opacity=0), 50);
            }

            if(gameState.ammo===0) {
                setTimeout(() => {
                    gameState.ammo = gameState.maxAmmo;
                    document.getElementById('ammoCount').textContent = gameState.ammo;
                }, 1500);
            }

            const bullet = new THREE.Mesh(
                new THREE.SphereGeometry(0.1),
                new THREE.MeshBasicMaterial({color:0xffff00})
            );

            bullet.position.copy(playerGroup.position);
            bullet.position.y += 1.5;

            const dir = new THREE.Vector3(Math.sin(mouseX), Math.sin(mouseY), -Math.cos(mouseX)).normalize();
            bullet.userData.velocity = dir.multiplyScalar(3);
            bullet.userData.life = 60;

            scene.add(bullet);
            bullets.push(bullet);

            setTimeout(() => checkHit(bullet), 10);
        }

        function checkHit(bullet) {
            otherPlayers.forEach(p => {
                if(p.userData.health<=0) return;

                if(bullet.position.distanceTo(p.position) < 2) {
                    p.userData.health -= 10;

                    const hp = p.userData.health / p.userData.maxHealth;
                    p.userData.healthBar.scale.x = hp;
                    p.userData.healthBar.position.x = -(1.5*(1-hp))/2;

                    if(p.userData.health <= 0) {
                        gameState.kills++;
                        addKillFeed(`You eliminated ${p.userData.id}`);
                        dropCoins(p);
                        p.visible = false;

                        const alive = otherPlayers.filter(p => p.userData.health>0).length + 1;
                        document.getElementById('playersAlive').textContent = alive;

                        if(alive === 1) setTimeout(() => showVictory(), 1000);
                    }
                }
            });
        }

        function dropCoins(player) {
            const cg = new THREE.Group();
            const coin = new THREE.Mesh(
                new THREE.CylinderGeometry(0.6,0.6,0.15,16),
                new THREE.MeshStandardMaterial({
                    color:0xffd700, emissive:0xffaa00, emissiveIntensity:0.8,
                    metalness:1, roughness:0.2
                })
            );
            coin.rotation.x = Math.PI/2;
            cg.add(coin);

            const light = new THREE.PointLight(0xffd700, 3, 15);
            light.position.y = 1;
            cg.add(light);

            cg.position.copy(player.position);
            cg.position.y = 0.5;
            cg.userData = {
                playerId: player.userData.id,
                amount: player.userData.stake,
                collected: false
            };

            scene.add(cg);
            coins.push(cg);
        }

        function checkCoinCollection() {
            coins.forEach(coin => {
                if(coin.userData.collected) return;

                const dist = playerGroup.position.distanceTo(coin.position);
                if(dist < 4) {
                    if(!gameState.nearbyCoins || gameState.nearbyCoins !== coin) {
                        gameState.nearbyCoins = coin;
                        const info = `${coin.userData.playerId} | ${coin.userData.amount.toFixed(3)} ${gameState.token}`;
                        document.getElementById('coinInfo').textContent = info;
                        document.getElementById('coinPopup').classList.remove('hidden');
                    }
                } else {
                    if(gameState.nearbyCoins === coin) {
                        gameState.nearbyCoins = null;
                        document.getElementById('coinPopup').classList.add('hidden');
                    }
                }
            });
        }

        window.collectCoins = function() {
            if(gameState.nearbyCoins) {
                gameState.collected += gameState.nearbyCoins.userData.amount;
                gameState.nearbyCoins.userData.collected = true;
                scene.remove(gameState.nearbyCoins);

                document.getElementById('coinPopup').classList.add('hidden');
                document.getElementById('hudCollected').textContent =
                    '+' + gameState.collected.toFixed(3) + ' ' + gameState.token;

                gameState.nearbyCoins = null;
            }
        };

        function addKillFeed(msg) {
            const div = document.createElement('div');
            div.className = 'kill-msg';
            div.textContent = msg;
            document.getElementById('killFeed').appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        // ==================== GAME OVER ====================
        function showVictory() {
            gameState.inGame = false;

            const totalPot = otherPlayers.reduce((s,p) => s+p.userData.stake, 0) + gameState.stake;
            const fee = totalPot * 0.05;
            const totalWin = totalPot - fee;
            const netProfit = totalWin - gameState.stake;

            document.getElementById('totalWinnings').textContent = totalWin.toFixed(3) + ' ' + gameState.token;
            document.getElementById('yourStake').textContent = gameState.stake.toFixed(3) + ' ' + gameState.token;
            document.getElementById('collectedAmount').textContent = gameState.collected.toFixed(3) + ' ' + gameState.token;
            document.getElementById('platformFee').textContent = fee.toFixed(3) + ' ' + gameState.token;
            document.getElementById('netProfit').textContent = netProfit.toFixed(3) + ' ' + gameState.token;

            document.getElementById('winnerModal').classList.remove('hidden');
            document.getElementById('crosshair').classList.add('hidden');
            document.getElementById('instructions').classList.add('hidden');
        }

        // ==================== ANIMATION ====================
        function animate() {
            requestAnimationFrame(animate);
            if(!gameState.inGame || !scene) return;

            const delta = clock.getDelta();
            if(playerMixer) playerMixer.update(delta);

            // Movement
            const vel = new THREE.Vector3();
            const spd = keys.shift ? moveSpeed*1.5 : moveSpeed;

            if(keys.w) vel.z -= spd;
            if(keys.s) vel.z += spd;
            if(keys.a) vel.x -= spd;
            if(keys.d) vel.x += spd;

            if(vel.length() > 0) {
                vel.applyEuler(new THREE.Euler(0, mouseX, 0));
                playerGroup.position.add(vel);

                const dist = Math.sqrt(playerGroup.position.x**2 + playerGroup.position.z**2);
                if(dist > 33) {
                    const a = Math.atan2(playerGroup.position.z, playerGroup.position.x);
                    playerGroup.position.x = Math.cos(a)*33;
                    playerGroup.position.z = Math.sin(a)*33;
                }
            }

            if(playerModel) playerModel.rotation.y = mouseX + Math.PI;

            // Shooting
            if(mouseDown && shootCooldown===0) shoot();
            if(shootCooldown>0) shootCooldown--;

            // Bullets
            bullets.forEach((b,i) => {
                b.position.add(b.userData.velocity);
                if(--b.userData.life <= 0) {
                    scene.remove(b);
                    bullets.splice(i,1);
                }
            });

            // AI movement
            otherPlayers.forEach(p => {
                if(p.userData.health<=0 || !p.userData.isAI) return;
                if(Math.random()<0.01) {
                    const a = Math.random()*Math.PI*2, s = 0.15;
                    p.position.x += Math.cos(a)*s*30;
                    p.position.z += Math.sin(a)*s*30;

                    const d = Math.sqrt(p.position.x**2 + p.position.z**2);
                    if(d > 33) {
                        const ang = Math.atan2(p.position.z, p.position.x);
                        p.position.x = Math.cos(ang)*33;
                        p.position.z = Math.sin(ang)*33;
                    }
                }

                p.children.forEach(c => {
                    if(c.geometry && c.geometry.type==='PlaneGeometry') {
                        c.lookAt(camera.position);
                    }
                });
            });

            // Coins
            coins.forEach(c => {
                if(!c.userData.collected) {
                    c.position.y = 0.5 + Math.sin(Date.now()*0.003)*0.3;
                    c.rotation.y += 0.03;
                }
            });

            checkCoinCollection();

            // Camera
            const camOff = new THREE.Vector3(
                Math.sin(mouseX)*10,
                6 + Math.sin(mouseY)*4,
                Math.cos(mouseX)*10
            );
            const camTgt = playerGroup.position.clone().add(camOff);
            camera.position.lerp(camTgt, 0.1);
            camera.lookAt(playerGroup.position.x, playerGroup.position.y+1.5, playerGroup.position.z);

            composer.render();
        }

        window.addEventListener('resize', () => {
            if(!camera || !renderer) return;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            if(composer) composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>

<script>
// Auto-hide loading screen after 2 seconds
setTimeout(() => {
    const loading = document.getElementById('loading');
    if (loading) {
        loading.style.display = 'none';
        console.log('‚úÖ Loading screen hidden');
    }
}, 2000);
</script>
